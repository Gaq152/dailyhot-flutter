name: æ„å»ºå¹¶å‘å¸ƒ APK

on:
  push:
    tags:
      - 'v*.*.*'  # å½“æ¨é€ v1.0.0 è¿™æ ·çš„æ ‡ç­¾æ—¶è§¦å‘

jobs:
  build-and-release:
    name: æ„å»º APK å¹¶å‘å¸ƒåˆ° GitHub Releases
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ·ï¸ è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          # ä» tag è·å–ç‰ˆæœ¬å·ï¼ˆå»æ‰ v å‰ç¼€ï¼‰
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$GITHUB_REF_NAME" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ ç‰ˆæœ¬: $VERSION"

      - name: ğŸ“ æå– CHANGELOG
        id: changelog
        run: |
          # ä» CHANGELOG.md ä¸­æå–å½“å‰ç‰ˆæœ¬çš„æ›´æ–°å†…å®¹
          VERSION=${{ steps.version.outputs.version }}

          # ä½¿ç”¨ awk æå–å¯¹åº”ç‰ˆæœ¬çš„å†…å®¹
          CHANGELOG=$(awk -v version="[$VERSION]" '
            $0 ~ version {flag=1; next}
            flag && /^---$/ {exit}
            flag && /^## \[/ {exit}
            flag && NF {print}
          ' CHANGELOG.md)

          # å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”ç‰ˆæœ¬çš„å†…å®¹ï¼Œä½¿ç”¨é»˜è®¤å†…å®¹
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="### æ›´æ–°å†…å®¹\n\nè¯¦è§ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)"
          fi

          # ä¿å­˜åˆ° GitHub Actions è¾“å‡ºï¼ˆä½¿ç”¨ EOF è¯­æ³•æ”¯æŒå¤šè¡Œï¼‰
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "âœ… å·²æå– CHANGELOG å†…å®¹"

      - name: â˜• è®¾ç½® Java ç¯å¢ƒ
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ğŸ“± è®¾ç½® Flutter ç¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.5'
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ è·å–ä¾èµ–
        run: flutter pub get

      - name: ğŸ” ä»£ç åˆ†æ
        run: flutter analyze --no-fatal-infos

      - name: ğŸ” é…ç½®ç­¾åå¯†é’¥
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          echo "ğŸ”‘ é…ç½® Release ç­¾å..."

          # éªŒè¯å¿…éœ€çš„secretsæ˜¯å¦å­˜åœ¨
          if [ -z "$KEYSTORE_BASE64" ]; then
            echo "âŒ é”™è¯¯: KEYSTORE_BASE64 secretæœªé…ç½®"
            exit 1
          fi

          # è§£ç  keystore æ–‡ä»¶
          echo "$KEYSTORE_BASE64" | base64 -d > android/app/upload-keystore.jks

          # åˆ›å»º key.properties æ–‡ä»¶
          cat > android/key.properties << EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=upload-keystore.jks
          EOF

          echo "âœ… ç­¾åé…ç½®å®Œæˆ"

      - name: ğŸ—ï¸ æ„å»º APK
        run: |
          echo "ğŸš€ å¼€å§‹æ„å»º Release APK..."
          flutter build apk --release
          echo "âœ… æ„å»ºå®Œæˆ"

      - name: ğŸ“‹ ç”Ÿæˆæ„å»ºä¿¡æ¯
        id: build_info
        run: |
          APK_PATH="build/app/outputs/apk/release/dailyhot.apk"
          APK_SIZE=$(ls -lh $APK_PATH | awk '{print $5}')
          APK_SHA256=$(sha256sum $APK_PATH | awk '{print $1}')

          echo "size=$APK_SIZE" >> $GITHUB_OUTPUT
          echo "sha256=$APK_SHA256" >> $GITHUB_OUTPUT

          echo "ğŸ“Š APK ä¿¡æ¯:"
          echo "   å¤§å°: $APK_SIZE"
          echo "   SHA256: $APK_SHA256"

      - name: ğŸ‰ åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: DailyHot ${{ steps.version.outputs.tag }}
          body: |
            ## ğŸ“± DailyHot ${{ steps.version.outputs.tag }}

            ${{ steps.changelog.outputs.content }}

            ---

            ### ğŸ“¥ ä¸‹è½½å®‰è£…

            ä¸‹è½½ä¸‹æ–¹çš„ `dailyhot.apk` æ–‡ä»¶ï¼Œå®‰è£…åˆ° Android è®¾å¤‡å³å¯ä½¿ç”¨ã€‚

            > **æ³¨æ„**ï¼šé¦–æ¬¡å®‰è£…å¯èƒ½éœ€è¦å…è®¸"å®‰è£…æœªçŸ¥æ¥æºåº”ç”¨"æƒé™

            ### ğŸ“Š æ„å»ºä¿¡æ¯

            - **æ–‡ä»¶å¤§å°**: ${{ steps.build_info.outputs.size }}
            - **SHA256**: `${{ steps.build_info.outputs.sha256 }}`
            - **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
            - **Flutter ç‰ˆæœ¬**: 3.35.5

            ### ğŸ”— ç›¸å…³é“¾æ¥

            - [æŸ¥çœ‹å®Œæ•´æ›´æ–°æ—¥å¿—](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
            - [æäº¤é—®é¢˜æˆ–å»ºè®®](https://github.com/${{ github.repository }}/issues)
            - [æºä»£ç ](https://github.com/${{ github.repository }})

            ---

            ğŸ¤– è‡ªåŠ¨æ„å»ºå¹¶å‘å¸ƒ
          files: |
            build/app/outputs/apk/release/dailyhot.apk
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
